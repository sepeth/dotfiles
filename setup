#!/bin/sh

FILES="
    bashrc
    ctags
    gdbinit
    gitconfig
    guile
    ipython
    inputrc
    lambda-term-inputrc
    psqlrc
    ripgreprc
    tmux.conf
    vim
    vimrc
"

BASEDIR=$(pwd)
MODE="nix"
ASTRONVIM_REPO="${ASTRONVIM_REPO:-git@github.com:sepeth/astronvim_conf.git}"
ASTRONVIM_DIR="${ASTRONVIM_DIR:-$HOME/.config/nvim}"

usage() {
    echo "Usage: $0 [--legacy] [--target TARGET]"
    echo "  --legacy  Run the previous symlink/Vundle flow"
    echo "  --target  Home Manager flake target (default: auto-detect)"
}

while [ $# -gt 0 ]; do
    case "$1" in
        --legacy)
            MODE="legacy"
            shift
            ;;
        --target)
            if [ -z "$2" ]; then
                echo "--target requires a value"
                exit 1
            fi
            TARGET="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

safe_link() {
    in="$BASEDIR/$1"

    if [ -z "$2" ]; then
        out=".$1"
    else
        out="$2"
    fi

    cd ~
    if [ -h "$out" ]; then
        echo "Already symlinked $out"
        cd $OLDPWD
        return
    elif [ -f "$out" ] || [ -d "$out" ]; then
        if [ ! -f "._$1" ]; then
            echo "There's an existing $out, moving to ._$1"
            mv "$out" "$(dirname $out)/._$1"
        else
            echo "There's already ._$1, can't create backup, skipping..."
        fi 
    fi
    ln -s $in $out
    echo "Symlinked $out"
    cd $OLDPWD
}

install_astronvim() {
    if ! command -v git >/dev/null 2>&1; then
        echo "git is not available; skipping AstroNvim config"
        return
    fi

    mkdir -p "$(dirname "$ASTRONVIM_DIR")"
    if [ -d "$ASTRONVIM_DIR/.git" ]; then
        echo "AstroNvim config already present at $ASTRONVIM_DIR"
    elif [ -e "$ASTRONVIM_DIR" ]; then
        echo "Existing $ASTRONVIM_DIR found; skipping AstroNvim config"
    else
        git clone "$ASTRONVIM_REPO" "$ASTRONVIM_DIR"
        echo "Cloned AstroNvim config to $ASTRONVIM_DIR"
    fi
}

if [ "$MODE" = "legacy" ]; then
    for f in $FILES; do
        safe_link "$f"
    done

    safe_link "fish" ".config/fish"

    git submodule update --init
    vim +PluginInstall +qall
    install_astronvim
else
    if command -v nix >/dev/null 2>&1; then
        if [ -z "$TARGET" ]; then
            case "$(uname -s)" in
                Darwin)
                    TARGET="sepeth-darwin"
                    ;;
                Linux)
                    if [ "$(uname -m)" = "aarch64" ]; then
                        TARGET="sepeth-linux-arm"
                    else
                        TARGET="sepeth-linux"
                    fi
                    ;;
                *)
                    echo "Unsupported OS; use --legacy or set a target manually."
                    exit 1
                    ;;
            esac
        fi

        # Note: `DOTFILES_REPO` is used by the activation hook to run `git submodule
        # update --init` and to link `Vundle.vim` from your working tree. It requires
        # `--impure` so Nix can read the environment variable.
        DOTFILES_REPO="$BASEDIR" \
        ASTRONVIM_REPO="$ASTRONVIM_REPO" \
        ASTRONVIM_DIR="$ASTRONVIM_DIR" \
        NIX_CONFIG="experimental-features = nix-command flakes" \
            nix run nixpkgs#home-manager -- switch --flake .#"$TARGET" --impure -b bak
    else
        echo "nix is not available; run with --legacy or install Nix."
        exit 1
    fi
fi
